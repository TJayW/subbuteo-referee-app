/**
 * StreamingControl - Integrated streaming control for Sidebar
 * 
 * Features:
 * - One-click start/stop
 * - Auto metadata sync with match state
 * - Compact UI for sidebar integration
 * - Real-time viewer count
 * - Share link with copy
 */

import { useState, useEffect } from 'react';
import { Video, VideoOff, Users, Copy, Check, Settings2, Maximize2, ExternalLink } from 'lucide-react';
import { useStreaming } from '@/hooks';
import { getCameraDevices, isBrowserSupported } from '@/adapters/media';
import type { DomainMatchState } from '@/domain/match/types';
import { STREAM_QUALITY_PRESETS } from '@/domain/streaming';

interface StreamingControlProps {
  matchState: DomainMatchState;
  homeTeamName: string;
  awayTeamName: string;
  compact?: boolean; // Compact mode for collapsed sidebar
  onExpandDashboard?: () => void; // Callback to open full dashboard
}

export function StreamingControl({ 
  matchState, 
  homeTeamName, 
  awayTeamName,
  compact = false,
  onExpandDashboard
}: StreamingControlProps) {
  const [isCopied, setIsCopied] = useState(false);
  const [showQualityMenu, setShowQualityMenu] = useState(false);
  const [cameras, setCameras] = useState<MediaDeviceInfo[]>([]);
  const [selectedCamera, setSelectedCamera] = useState<string>('');
  const [quality, setQuality] = useState<keyof typeof STREAM_QUALITY_PRESETS>('medium');
  const [isSupported] = useState(isBrowserSupported());

  const { 
    isStreaming, 
    viewerCount, 
    error, 
    startBroadcast, 
    stopBroadcast, 
    broadcastData,
    getStreamURL,
    localStream
  } = useStreaming({
    onError: (err) => console.error('Streaming error:', err),
  });

  // Load available cameras
  useEffect(() => {
    if (isSupported) {
      getCameraDevices().then(setCameras);
    }
  }, [isSupported]);

  // Auto-sync match metadata to viewers
  useEffect(() => {
    if (isStreaming && matchState) {
      // Compute score from events
      const score = {
        home: matchState.events.filter((e, i) => i < matchState.cursor && e.type === 'goal' && e.team === 'home').length,
        away: matchState.events.filter((e, i) => i < matchState.cursor && e.type === 'goal' && e.team === 'away').length,
      };
      
      const metadata = {
        homeTeam: homeTeamName,
        awayTeam: awayTeamName,
        score,
        period: matchState.period,
        time: formatTime(matchState.elapsedSeconds),
        phase: matchState.matchPhase,
      };
      
      broadcastData(metadata);
    }
  }, [
    isStreaming, 
    matchState?.events.length,
    matchState?.cursor,
    matchState?.period,
    matchState?.elapsedSeconds,
    matchState?.matchPhase,
    homeTeamName,
    awayTeamName,
    broadcastData,
    matchState,
  ]);

  const handleStartStream = async () => {
    try {
      await startBroadcast();
    } catch (err) {
      console.error('Failed to start stream:', err);
    }
  };

  const handleCopyLink = async () => {
    const url = getStreamURL();
    if (url) {
      await navigator.clipboard.writeText(url);
      setIsCopied(true);
      setTimeout(() => setIsCopied(false), 2000);
    }
  };

  // Not supported
  if (!isSupported) {
    return (
      <div className="p-3 bg-yellow-50 border border-yellow-200 rounded-md">
        <p className="text-xs text-yellow-800">
          Browser non supporta streaming (richiede HTTPS + WebRTC)
        </p>
      </div>
    );
  }

  // Compact mode (collapsed sidebar)
  if (compact) {
    return (
      <div className="flex flex-col items-center gap-2 p-2">
        <button
          onClick={isStreaming ? stopBroadcast : handleStartStream}
          className={`p-3 rounded-lg transition-colors ${
            isStreaming 
              ? 'bg-red-600 hover:bg-red-700 text-white' 
              : 'bg-green-600 hover:bg-green-700 text-white'
          }`}
          title={isStreaming ? 'Stop streaming' : 'Start streaming'}
        >
          {isStreaming ? <VideoOff className="w-5 h-5" /> : <Video className="w-5 h-5" />}
        </button>
        
        {isStreaming && (
          <div className="flex items-center gap-1 text-xs text-gray-600">
            <Users className="w-3 h-3" />
            <span>{viewerCount}</span>
          </div>
        )}
      </div>
    );
  }

  // Full mode
  return (
    <div className="space-y-3 p-4 bg-gradient-to-br from-blue-50 to-purple-50 border border-blue-200 rounded-lg">
      {/* Header */}
      <div className="flex items-center justify-between">
        <div className="flex items-center gap-2">
          <Video className="w-4 h-4 text-blue-600" />
          <h4 className="font-semibold text-sm">Streaming Live</h4>
        </div>
        {isStreaming && (
          <div className="flex items-center gap-1 px-2 py-0.5 bg-red-600 text-white rounded-full text-xs">
            <div className="w-1.5 h-1.5 bg-white rounded-full animate-pulse" />
            LIVE
          </div>
        )}
      </div>

      {/* Controls */}
      <div className="space-y-2">
        {!isStreaming ? (
          <>
            {/* Camera Selection */}
            {cameras.length > 1 && (
              <select
                value={selectedCamera}
                onChange={(e) => setSelectedCamera(e.target.value)}
                className="w-full px-2 py-1.5 text-sm border border-gray-300 rounded-md bg-white"
              >
                <option value="">Fotocamera predefinita</option>
                {cameras.map((camera) => (
                  <option key={camera.deviceId} value={camera.deviceId}>
                    {camera.label || `Camera ${camera.deviceId.substring(0, 8)}`}
                  </option>
                ))}
              </select>
            )}

            {/* Quality Selection */}
            <div className="relative">
              <button
                onClick={() => setShowQualityMenu(!showQualityMenu)}
                className="w-full flex items-center justify-between px-2 py-1.5 text-sm border border-gray-300 rounded-md bg-white hover:bg-gray-50"
              >
                <span className="flex items-center gap-1">
                  <Settings2 className="w-3 h-3" />
                  QualitÃ : {quality}
                </span>
              </button>
              
              {showQualityMenu && (
                <div className="absolute z-10 w-full mt-1 bg-white border border-gray-200 rounded-md shadow-lg">
                  {Object.keys(STREAM_QUALITY_PRESETS).map((preset) => (
                    <button
                      key={preset}
                      onClick={() => {
                        setQuality(preset as keyof typeof STREAM_QUALITY_PRESETS);
                        setShowQualityMenu(false);
                      }}
                      className="w-full px-3 py-2 text-left text-sm hover:bg-gray-100"
                    >
                      {preset} ({STREAM_QUALITY_PRESETS[preset].width}x{STREAM_QUALITY_PRESETS[preset].height})
                    </button>
                  ))}
                </div>
              )}
            </div>

            {/* Start Button */}
            <button
              onClick={handleStartStream}
              className="w-full flex items-center justify-center gap-2 px-3 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 font-medium text-sm"
            >
              <Video className="w-4 h-4" />
              Avvia Streaming
        ) : (
          <>
            {/* VIDEO PREVIEW - Mostra anteprima live */}
            {localStream && (
              <div className="relative aspect-video bg-black rounded-lg overflow-hidden border-2 border-red-500 shadow-lg">
                <video
                  autoPlay
                  muted
                  playsInline
                  ref={(video) => {
                    if (video && localStream) {
                      video.srcObject = localStream;
                    }
                  }}
                  className="w-full h-full object-cover"
                />
                
                {/* LIVE Badge Overlay */}
                <div className="absolute top-2 left-2 flex items-center gap-1.5 px-2 py-1 bg-red-600 text-white rounded-md text-xs font-bold shadow-lg">
                  <div className="w-2 h-2 bg-white rounded-full animate-pulse" />
                  LIVE
                </div>
                
                {/* Expand Button */}
                {onExpandDashboard && (
                  <button
                    onClick={onExpandDashboard}
                    className="absolute top-2 right-2 p-2 bg-black/70 hover:bg-black/90 text-white rounded-md transition-colors"
                    title="Apri dashboard completa"
                  >
                    <Maximize2 className="w-4 h-4" />
                  </button>
                )}
                
                {/* Viewer Count Overlay */}
                <div className="absolute bottom-2 left-2 flex items-center gap-1.5 px-2 py-1 bg-black/70 text-white rounded-md text-xs">
                  <Users className="w-3 h-3" />
                  <span className="font-medium">{viewerCount}</span>
            {/* Action Buttons Row */}
            <div className="flex gap-2">
              {onExpandDashboard && (
                <button
                  onClick={onExpandDashboard}
                  className="flex-1 flex items-center justify-center gap-2 px-3 py-2 bg-purple-600 text-white rounded-md hover:bg-purple-700 font-medium text-sm"
                >
                  <ExternalLink className="w-4 h-4" />
                  Dashboard
                </button>
              )}
              
              <button
                onClick={stopBroadcast}
                className="flex-1 flex items-center justify-center gap-2 px-3 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 font-medium text-sm"
              >
                <VideoOff className="w-4 h-4" />
                Ferma
              </button>
            </div>
          </>
        )}
      </div>      <span className="text-gray-600">
                    {viewerCount === 1 ? 'spettatore' : 'spettatori'}
                  </span>
                </div>
              </div>
            )}span>
              </div>
            </div>

            {/* Share Link */}
            <div className="space-y-1">
              <label className="block text-xs font-medium text-gray-700">
                Link spettatori
              </label>
              <div className="flex gap-1">
                <input
                  type="text"
                  value={getStreamURL()}
                  readOnly
                  className="flex-1 px-2 py-1.5 text-xs bg-white border border-gray-300 rounded-md"
                  onClick={(e) => e.currentTarget.select()}
                />
                <button
                  onClick={handleCopyLink}
                  className="px-2 py-1.5 bg-blue-600 text-white rounded-md hover:bg-blue-700"
                  title="Copia link"
                >
                  {isCopied ? <Check className="w-4 h-4" /> : <Copy className="w-4 h-4" />}
                </button>
              </div>
            </div>

            {/* Stop Button */}
            <button
              onClick={stopBroadcast}
              className="w-full flex items-center justify-center gap-2 px-3 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 font-medium text-sm"
            >
              <VideoOff className="w-4 h-4" />
              Ferma Streaming
            </button>
          </>
        )}
      </div>

      {/* Error Message */}
      {error && (
        <div className="p-2 bg-red-50 border border-red-200 rounded-md">
          <p className="text-xs text-red-700">{error}</p>
        </div>
      )}

      {/* Info */}
      {!isStreaming && (
        <div className="pt-2 border-t border-blue-200">
          <p className="text-xs text-gray-600">
            ðŸ’¡ Streaming P2P gratuito. Metadata partita sincronizzato automaticamente.
          </p>
        </div>
      )}
    </div>
  );
}

function formatTime(seconds: number): string {
  const mins = Math.floor(seconds / 60);
  const secs = seconds % 60;
  return `${mins}:${secs.toString().padStart(2, '0')}`;
}
